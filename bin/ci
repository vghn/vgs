#!/usr/bin/env bash
# Continuous Integration Tasks

# Immediately exit on errors
set -euo pipefail

# VARs
APPDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../" && pwd -P)"
AWS_S3_BUCKET="${AWS_S3_BUCKET:-}"
VERSION_FILE="${APPDIR}/VERSION"
VERSION=$(cat "$VERSION_FILE")
BUILD_NUM=${CIRCLE_BUILD_NUM:-0}
PKG_DIR=${CIRCLE_ARTIFACTS:-./pkg}
GIT_BRANCH=${CIRCLE_BRANCH:-$(git symbolic-ref --short HEAD 2>/dev/null)}
TARBALL="vgs-${VERSION}+${GIT_BRANCH}-${BUILD_NUM}.tgz"
TGZPATH="${PKG_DIR}/${TARBALL}"
S3PATH="s3://${AWS_S3_BUCKET}"

# Load functions
# shellcheck disable=1090
. "${APPDIR}/load"

# Sanity checks
sanity_checks(){
  # Create packaging directory if it does not exists
  [[ -d "$PKG_DIR" ]] || mkdir -p "$PKG_DIR"
  # Remove existing archive if it exists
  [[ ! -s "$TGZPATH" ]] || rm -f "$TGZPATH"
}

# Archive all system assets to a tarball ready for upload
archive_assets(){
  e_info "Archiving as ${TGZPATH}..."
  tar czvf "$TGZPATH" \
    bin lib load CHANGELOG.md LICENSE README.md VERSION
  e_ok 'Archiving complete.'
}

# Upload to S3 bucket then copy as latest.tgz
upload_to_s3(){
  e_info "Uploading to '${S3PATH}/${TARBALL}'..."
  aws s3 cp --acl public-read --storage-class REDUCED_REDUNDANCY \
    "$TGZPATH" "${S3PATH}/${TARBALL}"
  e_ok 'S3 upload complete.'

  if [[ "$GIT_BRANCH" == 'master' ]]; then
    e_info 'Copying the latest archive'
    aws s3 cp --acl public-read --storage-class STANDARD \
      "${S3PATH}/${TARBALL}" "${S3PATH}/vgs.tgz"
    e_ok 'S3 copy complete.'
  fi
}

ci_install(){
  cabal update; cabal install shellcheck
  pip install --user --upgrade awscli
}

# Use shellcheck to lint all .sh files
ci_test(){
  while IFS= read -r -d '' file; do
    shellcheck "$file" && e_ok "Sucessfully linted $file"
  done < <(find . -type f -name '*.sh' -print0)
}

ci_deploy(){
  sanity_checks && archive_assets && upload_to_s3
}

# Process arguments
case "${1:-}" in
  install)
    ci_install
    ;;
  test)
    ci_test
    ;;
  deploy)
    ci_deploy
    ;;
  *)
    e_abort "USAGE: ${BASH_SOURCE[0]} [install | test | deploy]"
    ;;
esac
